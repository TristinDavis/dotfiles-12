#!/usr/bin/env sh
# Serve a local directory via HTTP (via socat).

rep() {
    local status="${1:?Status is required.}"
    shift 1

    printf '%s %s %s\n' "$status" "$HTTP_METHOD" "$HTTP_PATH" 1>&2
    printf 'HTTP/1.0 %s\r\n' "$status"
    for hdr in "$@"; do
        printf '%s\r\n' "$hdr"
    done
    printf '\r\n'
    cat
}

http() {
    local HTTP_METHOD
    local HTTP_PATH
    local HTTP_VERSION

    read -r HTTP_METHOD HTTP_PATH HTTP_VERSION
    local rpath="$PWD$HTTP_PATH"

    if [ -r "${rpath}/index.html" ]; then
        rpath="${rpath}/index.html"
    fi

    if [[ "$rpath" = *..* ]]; then
        printf '' | rep 400
    elif [[ -d "$rpath" ]]; then
        ls "$rpath" | rep 200
    elif [[ -r "$rpath" ]]; then
        cat "$rpath" | rep 200 \
            "Content-Type: $(file -b --mime-type "$rpath")" \
            "Content-Length: $(wc -c < "$rpath")"
    else
        printf '' | rep 404
    fi
}

main() {
    if [[ $# -eq 0 ]]; then
        socat TCP-L:8000,fork,reuseaddr EXEC:"${0} http"
    else
        "$1" "$@"
    fi
}

# set -x
main "$@"
